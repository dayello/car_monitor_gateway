# JT1078 视频流传输处理流程层级分析

## 1. 整体架构层级

### 1.1 协议层 (Protocol Layer)
- **JT1078协议定义**: 基于中华人民共和国交通运输行业标准
- **核心消息类型**:
  - `0x9101`: 实时音视频传输请求
  - `0x9102`: 音视频实时传输控制  
  - `0x9105`: 实时音视频传输状态通知
  - `0x30316364`: 实时音视频流及透传数据传输
  - `0x1003`: 终端上传音视频属性
  - `0x1205`: 终端上传音视频资源列表

### 1.2 网络传输层 (Network Layer)
- **TCP服务器**: 端口7100 (可配置)
- **UDP服务器**: 端口7100 (可配置)  
- **报警附件服务器**: 端口7200 (T9208协议)
- **Web管理接口**: 端口8100

### 1.3 消息处理层 (Message Processing Layer)
- **编解码器**: JTMessageAdapter, JTMessageEncoder, JTMessageDecoder
- **多包处理**: MultiPacketDecoder, MultiPacketListener
- **数据帧处理**: DataFrameMessageDecoder (处理0x30316364标识)
- **消息推送**: JTMessagePushAdapter (SSE + Pulsar)

### 1.4 业务逻辑层 (Business Logic Layer)
- **控制器**: JT1078Controller (REST API接口)
- **端点处理器**: JT1078Endpoint (协议消息处理)
- **服务层**: MessageService, FileService
- **会话管理**: SessionManager

## 2. 视频流传输完整流程

### 2.1 初始化阶段
```
1. 设备注册 → JT808协议连接建立
2. 平台查询音视频属性 → T9003 → T1003响应
3. 设备上报音视频属性 → T1003
4. 平台查询资源列表 → T9205 → T1205响应
```

### 2.2 实时视频流传输阶段
```
1. 平台发起实时传输请求 → T9101
   ├── 服务器IP地址
   ├── TCP端口号
   ├── UDP端口号  
   ├── 逻辑通道号
   ├── 数据类型(音视频/视频/双向对讲/监听/中心广播/透传)
   └── 码流类型(主码流/子码流)

2. 设备响应 → T0001 (通用应答)

3. 设备开始传输视频流 → 0x30316364
   ├── 帧头标识: 0x30 0x31 0x63 0x64
   ├── 数据包处理: DataFrameMessageDecoder
   └── 实时推送: SSE + Pulsar

4. 平台控制传输 → T9102
   ├── 关闭音视频传输
   ├── 切换码流
   ├── 暂停/恢复传输
   └── 关闭双向对讲

5. 设备状态通知 → T9105
   └── 丢包率上报
```

### 2.3 录像回放阶段
```
1. 平台下发回放请求 → T9201
2. 设备响应资源列表 → T1205
3. 平台下发回放控制 → T9202
4. 设备传输录像数据 → 0x30316364
```

### 2.4 文件上传阶段
```
1. 平台下发文件上传指令 → T9206
2. 设备响应 → T0001
3. 平台下发文件上传控制 → T9207
4. 设备上传文件数据 → T0801 (多媒体数据上传)
5. 文件保存处理 → FileService.saveMediaFile()
```

## 3. 关键组件详解

### 3.1 消息编解码器
- **JTMessageAdapter**: 基础编解码适配器
- **JTMessagePushAdapter**: 带推送功能的适配器
- **DataFrameMessageDecoder**: 专门处理视频流数据帧
- **MultiPacketDecoder**: 处理分包消息

### 3.2 服务器配置
```yaml
jt-server:
  jt808:
    tcp-port: 7100      # JT808 TCP端口
    udp-port: 7100      # JT808 UDP端口
    idle-timeout: 180   # 心跳超时(秒)
    t0801:
      path: D:/jt_data/media_file  # 多媒体文件存储路径
    t9208:
      host: 127.0.0.1
      port: 7200        # 报警附件服务器端口
      enabled: true
      path: D:/jt_data/alarm_file  # 报警附件存储路径
```

### 3.3 数据包结构
```
视频流数据包 (0x30316364):
├── 帧头标识: 4字节 (0x30 0x31 0x63 0x64)
├── 文件名称: 50字节
├── 数据偏移量: 4字节
├── 数据长度: 4字节
└── 数据体: 变长
```

## 4. 处理层级总结

1. **协议层**: JT1078标准协议定义和消息类型
2. **传输层**: TCP/UDP网络传输和端口管理
3. **编解码层**: 消息序列化/反序列化和数据帧处理
4. **业务层**: 视频流控制、文件管理、会话管理
5. **接口层**: REST API和WebSocket推送
6. **存储层**: 多媒体文件和报警附件存储

## 5. 数据流向

```
设备端 ←→ 网络传输 ←→ 网关服务器 ←→ 业务处理 ←→ 存储/推送
  ↓           ↓            ↓           ↓         ↓
音视频设备   TCP/UDP    消息编解码   业务逻辑   文件系统
摄像头      端口7100    JT1078协议   会话管理   SSE推送
麦克风      端口7200    数据帧处理   文件服务   Pulsar
```

这个架构实现了完整的JT1078视频流传输处理，支持实时视频传输、录像回放、文件上传等多种功能。
