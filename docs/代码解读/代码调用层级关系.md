# JT1078 项目代码调用层级关系

## 1. 整体架构调用层级

### 1.1 网络层 (Network Layer)
```
Netty服务器启动
├── NewJTSocket (配置类)
│   ├── jt808TCPServer() → NettyConfig → TCPServer
│   ├── jt808UDPServer() → NettyConfig → UDPServer  
│   └── alarmFileServer() → NettyConfig → TCPServer (报警附件)
│
├── NettyConfig.Builder
│   ├── setPort() → 端口配置
│   ├── setDecoder() → 消息解码器
│   ├── setEncoder() → 消息编码器
│   ├── setHandlerMapping() → 处理器映射
│   └── build() → Server实例
│
└── Server.start()
    ├── TCPServer.start()
    └── UDPServer.start()
```

### 1.2 消息处理层 (Message Processing Layer)
```
网络数据接收
├── MessageDecoderWrapper.channelRead()
│   ├── decoder.decode(input, session) → JTMessageAdapter.decode()
│   └── ctx.fireChannelRead(packet.replace(message))
│
├── DispatcherHandler.channelRead()
│   ├── handlerMapping.getHandler(messageId) → HandlerMapping
│   ├── handler.invoke(request, session) → Handler.invoke()
│   └── ctx.writeAndFlush(packet.replace(response))
│
└── HandlerInterceptor
    ├── beforeHandle() → 前置处理
    ├── afterHandle() → 后置处理
    └── exceptional() → 异常处理
```

## 2. 核心组件调用关系

### 2.1 消息编解码调用链
```
ByteBuf输入
├── JTMessageAdapter.decode()
│   ├── JTMessageDecoder.decode()
│   │   ├── unescape() → 反转义处理
│   │   ├── verify() → 校验码验证
│   │   ├── SchemaManager.getRuntimeSchema() → 获取消息Schema
│   │   └── bodySchema.mergeFrom() → 反序列化消息体
│   └── message.setSession(session)
│
├── MultiPacketDecoder.decode() (继承JTMessageDecoder)
│   ├── addAndGet() → 分包处理
│   └── MultiPacketListener → 分包监听器
│
└── DataFrameMessageDecoder.decode() (继承JTMessageDecoder)
    ├── ByteBufUtils.startsWith() → 检查帧头标识
    └── dataFrameSchema.mergeFrom() → 数据帧反序列化
```

### 2.2 消息编码调用链
```
JTMessage输出
├── JTMessageAdapter.encode()
│   ├── JTMessageEncoder.encode()
│   │   ├── SchemaManager.getRuntimeSchema() → 获取消息Schema
│   │   ├── bodySchema.writeTo() → 序列化消息体
│   │   ├── headSchema.writeTo() → 序列化消息头
│   │   ├── sign() → 添加校验码
│   │   └── escape() → 转义处理
│   └── encodeLog() → 编码日志记录
│
└── JTMessagePushAdapter.encodeLog()
    ├── SSEService.send() → SSE推送
    └── PulsarService.publishDown() → Pulsar消息队列
```

### 2.3 处理器映射调用链
```
消息类型路由
├── HandlerMapping.getHandler(messageId)
│   ├── SpringHandlerMapping (Spring容器)
│   │   ├── ApplicationContext.getBeansWithAnnotation(Endpoint.class)
│   │   └── registerHandlers() → 注册处理器
│   └── DefaultHandlerMapping (非Spring)
│       ├── ClassUtils.getClassList() → 扫描Endpoint类
│       └── registerHandlers() → 注册处理器
│
├── AbstractHandlerMapping.registerHandlers()
│   ├── Method.getAnnotation(Mapping.class) → 获取映射注解
│   ├── new SimpleHandler() → 创建简单处理器
│   └── handlerMap.put(type, handler) → 存储映射关系
│
└── Handler.invoke()
    ├── targetMethod.invoke(targetObject, args) → 反射调用
    └── 参数类型匹配 (MESSAGE/SESSION)
```

## 3. 业务逻辑调用层级

### 3.1 Endpoint处理器调用链
```
@Endpoint类方法调用
├── JT808Endpoint
│   ├── T0001() → 终端注册
│   ├── T0100() → 终端鉴权
│   ├── T0200() → 位置信息上报
│   └── T0801() → 多媒体数据上传
│
├── JT1078Endpoint  
│   ├── T1003() → 终端上传音视频属性
│   ├── T1005() → 终端上传乘客流量
│   ├── T1205() → 终端上传音视频资源列表
│   └── T1206() → 文件上传完成通知
│
└── JSATL12Endpoint
    ├── T1210() → 报警附件信息上传
    └── T1211() → 文件信息上传
```

### 3.2 Controller控制器调用链
```
REST API调用
├── JT808Controller
│   ├── T0001() → 终端注册请求
│   ├── T0100() → 终端鉴权请求
│   └── T0200() → 位置信息查询
│
├── JT1078Controller
│   ├── T9003() → 查询终端音视频属性
│   ├── T9101() → 实时音视频传输请求
│   ├── T9102() → 音视频实时传输控制
│   ├── T9201() → 平台下发远程录像回放请求
│   └── T9206() → 文件上传指令
│
└── OtherController
    ├── all() → 终端实时信息查询
    ├── getClientId() → 获得在线设备信息
    └── sseConnect() → SSE连接建立
```

### 3.3 服务层调用链
```
业务服务调用
├── MessageService
│   ├── requestR() → 请求响应处理
│   ├── notifyR() → 通知处理
│   └── SessionManager.get() → 获取会话
│
├── FileService
│   ├── saveMediaFile() → 多媒体文件保存
│   ├── writeFile() → 报警文件写入
│   ├── checkFile() → 文件完整性检查
│   └── createDir() → 创建报警目录
│
└── PulsarService
    ├── publishUp() → 上行消息发布
    └── publishDown() → 下行消息发布
```

## 4. 会话管理调用层级

### 4.1 Session生命周期管理
```
会话创建和管理
├── SessionManager
│   ├── newInstance() → 创建新会话
│   ├── add() → 注册会话
│   ├── remove() → 移除会话
│   └── get() → 获取会话
│
├── Session
│   ├── register() → 注册到SessionManager
│   ├── request() → 请求响应处理
│   ├── notify() → 通知处理
│   └── response() → 响应处理
│
└── SessionListener
    ├── sessionCreated() → 会话创建回调
    ├── sessionRegistered() → 会话注册回调
    └── sessionDestroyed() → 会话销毁回调
```

### 4.2 消息推送调用链
```
实时消息推送
├── JTMessagePushAdapter
│   ├── encodeLog() → 编码日志推送
│   │   ├── SSEService.send() → SSE推送
│   │   └── PulsarService.publishDown() → Pulsar下行推送
│   └── decodeLog() → 解码日志推送
│       ├── SSEService.send() → SSE推送
│       └── PulsarService.publishUp() → Pulsar上行推送
│
├── SSEService
│   ├── connect() → 建立SSE连接
│   ├── send() → 发送SSE消息
│   ├── addEvent() → 添加事件监听
│   └── delEvent() → 删除事件监听
│
└── PulsarService
    ├── publishUp() → 发布上行消息
    └── publishDown() → 发布下行消息
```

## 5. 配置和初始化调用层级

### 5.1 Spring配置调用链
```
Spring容器初始化
├── NewJTSocket (配置类)
│   ├── jtMessageAdapter() → 消息适配器Bean
│   ├── sessionManager() → 会话管理器Bean
│   ├── schemaManager() → Schema管理器Bean
│   └── multiPacketDecoder() → 多包解码器Bean
│
├── JTProperties (配置属性)
│   ├── tcpPort → TCP端口配置
│   ├── udpPort → UDP端口配置
│   ├── t0801 → 多媒体文件配置
│   └── t9208 → 报警附件配置
│
└── HandlerMapping (处理器映射)
    ├── SpringHandlerMapping → Spring容器管理
    └── registerHandlers() → 注册所有Endpoint
```

## 6. 数据流向调用层级

### 6.1 上行数据流 (设备→平台)
```
设备数据 → 网络传输 → 网关处理 → 业务逻辑 → 存储/推送
    ↓           ↓           ↓          ↓         ↓
音视频设备   TCP/UDP    消息解码    业务处理   文件存储
摄像头      端口7100   JT1078协议  会话管理   SSE推送
麦克风      端口7200   数据帧处理  文件服务   Pulsar队列
```

### 6.2 下行数据流 (平台→设备)
```
平台指令 → 业务逻辑 → 消息编码 → 网络传输 → 设备执行
    ↓         ↓         ↓         ↓         ↓
REST API   服务层    消息编码    TCP/UDP   设备响应
Controller  MessageService  JTMessageEncoder  端口7100   终端设备
```

## 7. 关键调用时序

### 7.1 设备注册流程
```
1. 设备连接 → TCPServer/UDP Server
2. 消息解码 → JTMessageAdapter.decode()
3. 路由分发 → DispatcherHandler.channelRead()
4. 处理器调用 → JT808Endpoint.T0001()
5. 会话注册 → Session.register()
6. 响应编码 → JTMessageAdapter.encode()
7. 数据发送 → Channel.writeAndFlush()
```

### 7.2 视频流传输流程
```
1. 平台请求 → JT1078Controller.T9101()
2. 消息发送 → MessageService.requestR()
3. 设备响应 → JT1078Endpoint.T1003()
4. 视频流传输 → DataFrameMessageDecoder.decode()
5. 实时推送 → JTMessagePushAdapter.decodeLog()
6. 文件保存 → FileService.saveMediaFile()
```

这个调用层级关系展示了整个JT1078项目的代码组织结构，从底层的网络传输到上层的业务逻辑，形成了一个完整的消息处理链路。
